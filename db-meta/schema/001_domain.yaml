botecopro_domain:
  version: 1.0
  project: boteco_pro
  description: "BotecoPro Unified Domain Model - Language Agnostic"

  metadata:
    offline_first: true
    uuid_primary:
      - Comanda
      - DomainEvent
    money_unit: "cents"
    timestamps: "iso8601"
    sync_fields: ["last_modified", "dirty", "origin_device"]

  targets:
    python:
      orm: sqlalchemy
      db: sqlite
    sql:
      dialect: sqlite
    dart:
      enabled: true

  types:
    money_cents:
      base: int
      description: Monetary value in cents.
    timestamp:
      base: datetime
      format: iso8601

  enums:
    ItemType: ["dish", "drink", "article"]
    OrderStatus: ["open", "preparing", "ready", "delivered", "cancelled"]
    ComandaStatus: ["open", "closed", "cancelled"]
    TicketStatus: ["new", "cooking", "ready", "delivered"]
    PaymentMethod: ["cash", "card", "pix", "voucher", "tab"]
    MovementType: ["in", "out", "adjustment"]
    OriginType: ["table", "takeaway", "delivery"]

  entities:

    ############################################################
    # CATEGORY
    ############################################################
    Category:
      storage:
        table: category
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        name:
          type: string
          required: true
      methods: []

    Subcategory:
      storage:
        table: subcategory
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        name:
          type: string
          required: true
        category_id:
          type: relation
          target: Category
          target_field: id
          nullable: false
      methods: []

    ############################################################
    # PRODUCT (INGREDIENT)
    ############################################################
    Product:
      storage:
        table: product
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        name:
          type: string
          required: true
        description:
          type: string
          nullable: true
        cost_price_cents:
          type: money_cents
          nullable: true
        stock_current:
          type: float
          nullable: true
        stock_minimum:
          type: float
          nullable: true
        unit:
          type: string
          nullable: true
        product_type:
          type: string
          nullable: true
        active:
          type: bool
          default: true
        last_modified:
          type: timestamp
          nullable: true
        dirty:
          type: bool
          default: false
        origin_device:
          type: string
          nullable: true
      methods:
        - calculate_stock_value

    Supplier:
      storage:
        table: supplier
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        name:
          type: string
          required: true
        email:
          type: string
          nullable: true
        phone:
          type: string
          nullable: true
        notes:
          type: string
          nullable: true
      methods: []

    SupplierProduct:
      storage:
        table: supplier_product
      attributes:
        product_id:
          type: relation
          target: Product
          target_field: id
          primary_key: true
        supplier_id:
          type: relation
          target: Supplier
          target_field: id
          primary_key: true
        price_cents:
          type: money_cents
          nullable: true
        notes:
          type: string
          nullable: true
      methods: []

    ############################################################
    # MENU ITEMS
    ############################################################
    Item:
      storage:
        table: item
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        name:
          type: string
          required: true
        description:
          type: string
          nullable: true
        sale_price_cents:
          type: money_cents
          nullable: true
        unit_cost_cents:
          type: money_cents
          nullable: true
        prep_time_min:
          type: int
          nullable: true
        item_type:
          type: enum
          enum: ItemType
          nullable: false
        category_id:
          type: relation
          target: Category
          target_field: id
          nullable: true
        subcategory_id:
          type: relation
          target: Subcategory
          target_field: id
          nullable: true
        active:
          type: bool
          default: true
        notes:
          type: string
          nullable: true
        last_modified:
          type: timestamp
          nullable: true
        dirty:
          type: bool
          default: false
        origin_device:
          type: string
          nullable: true
      methods:
        - calculate_price
        - calculate_cost

    ItemProduct:
      storage:
        table: item_product
      attributes:
        item_id:
          type: relation
          target: Item
          target_field: id
          primary_key: true
        product_id:
          type: relation
          target: Product
          target_field: id
          primary_key: true
        quantity:
          type: float
          nullable: false
      methods: []

    ############################################################
    # TABLES
    ############################################################
    DiningTable:
      storage:
        table: dining_table
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        table_num:
          type: int
          required: true
        seats:
          type: int
          nullable: true
        available:
          type: bool
          default: true
      methods:
        - mark_available
        - mark_unavailable

    ############################################################
    # COMANDA
    ############################################################
    Comanda:
      storage:
        table: comanda
      attributes:
        id:
          type: uuid
          primary_key: true
        table_id:
          type: relation
          target: DiningTable
          target_field: id
          nullable: true
        status:
          type: enum
          enum: ComandaStatus
          nullable: false
        opened_at:
          type: timestamp
          nullable: true
        closed_at:
          type: timestamp
          nullable: true
        subtotal_cents:
          type: money_cents
          nullable: true
        total_cents:
          type: money_cents
          nullable: true
        notes:
          type: string
          nullable: true
        last_modified:
          type: timestamp
          nullable: true
        dirty:
          type: bool
          default: false
        origin_device:
          type: string
          nullable: true
      methods:
        - calculate_totals
        - close
        - reopen

    ############################################################
    # EMPLOYEES & CUSTOMERS
    ############################################################
    Employee:
      storage:
        table: employee
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        name:
          type: string
          nullable: true
        role:
          type: string
          nullable: true
        email:
          type: string
          nullable: true
        hourly_rate_cents:
          type: money_cents
          nullable: true
      methods:
        - clock_in
        - clock_out

    Customer:
      storage:
        table: customer
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        name:
          type: string
          nullable: true
        customer_type:
          type: string
          nullable: true
      methods: []

    ############################################################
    # ORDER HEADER
    ############################################################
    Order:
      storage:
        table: "order"
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        comanda_id:
          type: relation
          target: Comanda
          target_field: id
          nullable: false
        employee_id:
          type: relation
          target: Employee
          target_field: id
          nullable: true
        customer_id:
          type: relation
          target: Customer
          target_field: id
          nullable: true
        origin:
          type: enum
          enum: OriginType
          nullable: false
        status:
          type: enum
          enum: OrderStatus
          nullable: false
        created_at:
          type: timestamp
          nullable: true
        notes:
          type: string
          nullable: true
        last_modified:
          type: timestamp
          nullable: true
        dirty:
          type: bool
          default: false
        origin_device:
          type: string
          nullable: true
      methods:
        - add_item
        - remove_item
        - change_status
        - total

    ############################################################
    # ORDER ITEMS
    ############################################################
    OrderItem:
      storage:
        table: order_item
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        order_id:
          type: relation
          target: Order
          target_field: id
          nullable: false
        item_id:
          type: relation
          target: Item
          target_field: id
          nullable: false
        quantity:
          type: int
          nullable: false
        unit_price_cents:
          type: money_cents
          nullable: false
        discount_percent:
          type: float
          nullable: true
        tax_percent:
          type: float
          nullable: true
        total_cents:
          type: money_cents
          nullable: true
        notes:
          type: string
          nullable: true
        last_modified:
          type: timestamp
          nullable: true
        dirty:
          type: bool
          default: false
        origin_device:
          type: string
          nullable: true
      methods:
        - subtotal
        - apply_discount

    ############################################################
    # INVOICE
    ############################################################
    Invoice:
      storage:
        table: invoice
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        comanda_id:
          type: relation
          target: Comanda
          target_field: id
          nullable: false
        subtotal_cents:
          type: money_cents
          nullable: true
        tax_total_cents:
          type: money_cents
          nullable: true
        total_cents:
          type: money_cents
          nullable: true
        closed_at:
          type: timestamp
          nullable: true
      methods:
        - generate
        - archive

    ############################################################
    # PAYMENTS
    ############################################################
    Payment:
      storage:
        table: payment
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        comanda_id:
          type: relation
          target: Comanda
          target_field: id
          nullable: false
        method:
          type: enum
          enum: PaymentMethod
          nullable: false
        amount_cents:
          type: money_cents
          nullable: false
        received_at:
          type: timestamp
          nullable: true
        notes:
          type: string
          nullable: true
      methods:
        - refund

    PaymentSplit:
      storage:
        table: payment_split
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        payment_id:
          type: relation
          target: Payment
          target_field: id
          nullable: false
        payee_name:
          type: string
          nullable: true
        amount_cents:
          type: money_cents
          nullable: false
      methods: []

    ############################################################
    # STOCK MOVEMENTS
    ############################################################
    StockMovement:
      storage:
        table: stock_movement
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        product_id:
          type: relation
          target: Product
          target_field: id
          nullable: false
        quantity:
          type: float
          nullable: false
        movement_type:
          type: enum
          enum: MovementType
          nullable: false
        reason:
          type: string
          nullable: true
        related_order_item:
          type: relation
          target: OrderItem
          target_field: id
          nullable: true
        created_at:
          type: timestamp
          nullable: true
      methods:
        - apply

    ############################################################
    # KITCHEN / BAR TICKETS
    ############################################################
    KitchenTicket:
      storage:
        table: kitchen_ticket
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        order_id:
          type: relation
          target: Order
          target_field: id
          nullable: false
        status:
          type: enum
          enum: TicketStatus
          nullable: false
        created_at:
          type: timestamp
          nullable: true
      methods:
        - advance
        - mark_ready

    KitchenTicketItem:
      storage:
        table: kitchen_ticket_item
      attributes:
        id:
          type: int
          primary_key: true
          autoincrement: true
        ticket_id:
          type: relation
          target: KitchenTicket
          target_field: id
          nullable: false
        order_item_id:
          type: relation
          target: OrderItem
          target_field: id
          nullable: false
      methods: []

  ############################################################
  # DOMAIN EVENTS (DDD)
  ############################################################
  events:
    OrderOpened:
      aggregate: Order
      payload:
        order_id: { type: int }
        comanda_id: { type: uuid }
        table_id: { type: int }
        employee_id: { type: int }

    ItemAdded:
      aggregate: Order
      payload:
        order_item_id: { type: int }
        order_id: { type: int }
        item_id: { type: int }
        quantity: { type: int }

    ItemStatusChanged:
      aggregate: OrderItem
      payload:
        order_item_id: { type: int }
        from: { type: string }
        to: { type: string }

    OrderClosed:
      aggregate: Order
      payload:
        order_id: { type: int }
        total_cents: { type: money_cents }

    PaymentReceived:
      aggregate: Payment
      payload:
        payment_id: { type: int }
        comanda_id: { type: uuid }
        amount_cents: { type: money_cents }
        method: { type: string }

    StockConsumed:
      aggregate: StockMovement
      payload:
        product_id: { type: int }
        quantity: { type: float }
        order_item_id: { type: int }
