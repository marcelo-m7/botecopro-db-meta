-- SQL table for {{ entity.entity }} (schema: {{ entity.schema }})
CREATE table IF NOT EXISTS {{ entity.table }};
CREATE TABLE IF NOT EXISTS {{ entity.schema }}.{{ entity.entity }} (
{% for name, attr in entity.attributes.items() -%}
  {{ name }} {{ 'UUID' if attr.type=='uuid' else ('TEXT' if attr.type in ['string','text'] else ('INTEGER' if attr.type=='integer' else ('BOOLEAN' if attr.type=='boolean' else ('DECIMAL(' + (str(attr.precision) if attr.get('precision') else '12') + ',' + (str(attr.scale) if attr.get('scale') else '2') + ')' if attr.type=='decimal' else ('JSONB' if attr.type in ['json','jsonb'] else 'TIMESTAMP'))))) }}{% if attr.get('nullable')==False %} NOT NULL{% endif %}{% if not loop.last %},{% endif %}
{% endfor %}
);

{% if entity.get('indexes') %}
-- Indexes
{% set ns = namespace(counts={}) %}
{% for idx in entity.indexes %}
{% set base_name = 'idx_' ~ entity.entity ~ '_' ~ '_'.join(idx.columns) %}
{% set count = ns.counts.get(base_name, 0) %}
{% set index_name = base_name if count == 0 else base_name ~ '_' ~ (count + 1) %}
{% set _ = ns.counts.__setitem__(base_name, count + 1) %}
CREATE {% if idx.get('unique') %}UNIQUE {% endif %}INDEX IF NOT EXISTS {{ index_name }} ON {{ entity.schema }}.{{ entity.entity }} ({{ ','.join(idx.columns) }});
{% endfor %}
{% endif %}
